{{ block title }}{{ endblock }}

{{ block content }}

<style>
  body {
    font-size: 22px;           /* overall bigger text */
  }

  #game-area {
    margin-top: 5rem;
  }

  #status-text {
    font-size: 2rem;          /* big “Wait…” / feedback text */
    font-weight: 600;
  }

  .big-button {
    font-size: 1.8rem;
    padding: 1.2rem 3rem;     /* taller & wider buttons */
  }

  #intro-overlay p {
    font-size: 1.4rem;
    line-height: 1.6;
  }

  #game-area.faded {
      opacity: 0.4;                /* fade */
      filter: grayscale(70%);      /* optional, makes buttons/text look disabled */
      pointer-events: none;        /* prevents clicking */
      transition: opacity 0.3s ease, filter 0.3s ease;
  }
</style>

<!-- Intro overlay -->
<div id="intro-overlay"
     style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
            background-color:rgba(255,255,255,0.95); cursor:pointer; z-index:10;">
  <div style="max-width:600px; text-align:center;">
    <p>
      In this game, you have two options, either left or right. On each turn,
      you will select one of the options and be told how much you were rewarded.
      At the end of the game, you will be paid based on your total reward.
    </p>
    <p style="margin-top:1.5rem; font-weight:bold;">
      Click anywhere to proceed
    </p>
  </div>
</div>

<!-- Full-page flexbox wrapper (slightly upward: justify-content:flex-start + top padding) -->
<div id="game-wrapper"
     style="
       position:relative;
       height:100vh;
       display:flex;
       align-items:flex-start;
       justify-content:center;
       padding-top:10vh;  /* Controls upward shift: lower value = higher */
     ">

  <!-- Gray-out overlay -->
  <div id="wait-overlay" 
      style="
          position:absolute;
          inset:0;
          background:rgba(200,200,200,0.6);
          backdrop-filter: blur(2px);
          z-index:5;
          display:none;
      ">
  </div>

  <!-- Main game area (now scaled up) -->
  <div id="game-area" style="text-align:center; display:none; transform:scale(1.6);">

    <div id="total-points" style="font-size:1.8rem; margin-top:1rem;">
      Total points: <span id="points-value">0</span>
    </div>

    <div id="status-text" style="margin-bottom:3rem; font-size:2rem; font-weight:bold;">
      Wait...
    </div>

    <div style="display:flex; justify-content:center; gap:4rem; margin-bottom:3rem;">
      <button id="left-btn" class="btn btn-primary" disabled
              style="font-size:2rem; padding:1rem 2.5rem;">
        Left
      </button>
      <button id="right-btn" class="btn btn-primary" disabled
              style="font-size:2rem; padding:1rem 2.5rem;">
        Right
      </button>
    </div>

    <div style="margin-bottom:3rem; font-size:1rem; transform: translateX(-3%);">
      <span>Round <span id="trial-number">1</span> / <span id="trial-total">10</span></span>
    </div>


  </div>

</div>


<script>
  const introOverlay = document.getElementById("intro-overlay");
  const gameArea = document.getElementById("game-area");
  const statusText = document.getElementById("status-text");
  const leftBtn = document.getElementById("left-btn");
  const rightBtn = document.getElementById("right-btn");
  const trialNumberSpan = document.getElementById("trial-number");
  const pointsValueSpan = document.getElementById("points-value");
  const waitOverlay = document.getElementById("wait-overlay");

  function fadeGameArea() {
      document.getElementById("game-area").classList.add("faded");
  }

  function unfadeGameArea() {
      document.getElementById("game-area").classList.remove("faded");
  }

  let waitingForChoice = false;
  let finished = false;

  function setButtonsEnabled(enabled) {
    leftBtn.disabled = !enabled;
    rightBtn.disabled = !enabled;
  }

  // Intro: click anywhere to start
  introOverlay.addEventListener("click", function () {
    introOverlay.style.display = "none";
    gameArea.style.display = "block";
    // Tell server we are starting the game
    liveSend({type: "start"});
    statusText.textContent = "Wait...";
  });

  // Start one trial: Wait... (2 s) then "Select your choice now"
  function startChoicePhase() {
    if (finished) return;

    // Begin WAIT state
    statusText.textContent = "Wait...";
    setButtonsEnabled(false);
    fadeGameArea();   // fade everything

    // After X seconds, enable choice
    setTimeout(function () {
      if (finished) return;
      unfadeGameArea();    // restore normal brightness
      statusText.textContent = "Select your choice now";
      setButtonsEnabled(true);
      waitingForChoice = true;
    }, 2000); // 2 seconds
  }

  // Button handlers
  leftBtn.onclick = function () {
    if (!waitingForChoice || finished) return;
    waitingForChoice = false;
    setButtonsEnabled(false);
    liveSend({type: "choice", choice: "L"});
  };

  rightBtn.onclick = function () {
    if (!waitingForChoice || finished) return;
    waitingForChoice = false;
    setButtonsEnabled(false);
    liveSend({type: "choice", choice: "R"});
  };

  // Handle messages from the server
  function liveRecv(data) {
    if (data.type === "ready") {
      trialNumberSpan.textContent = data.trial;
      pointsValueSpan.textContent = data.total_points;

      // Optional: show phase somewhere
      statusText.textContent = (data.phase === "single")
        ? "Single-player block: wait..."
        : "Two-player block: wait...";

      startChoicePhase();

    } else if (data.type === "wait_opponent") {
      // You already made your choice in multiplayer; just wait for the other player.
      trialNumberSpan.textContent = data.trial;
      pointsValueSpan.textContent = data.total_points;
      setButtonsEnabled(false);
      statusText.textContent = "Waiting for the other player...";
      fadeGameArea();

    } else if (data.type === "feedback") {
      trialNumberSpan.textContent = data.trial;
      pointsValueSpan.textContent = data.total_points;

      if (data.phase === "single") {
        statusText.textContent = "You won " + data.reward + " points";

      } else if (data.phase === "multi") {
        // data.other_choice is provided in multi phase
        statusText.textContent =
          "You chose " + data.your_choice +
          ", other chose " + data.other_choice +
          ". You won " + data.reward + " points";
      }

      if (data.is_last) {
        finished = true;
        setTimeout(function () {
          statusText.textContent =
            "This is the end of the game. You have won " +
            data.total_points + " points in total.";
        }, 1500);
      } else {
        setTimeout(function () {
          unfadeGameArea();
          startChoicePhase();
        }, 1500);
      }
    }
  }
</script>

{{ endblock }}
